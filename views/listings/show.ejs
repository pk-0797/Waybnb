<% layout("/layouts/boilerplate.ejs") %>

<body>
  <div class="container my-5">

    <!-- Property Details -->
    <h3 class="mb-4 text-center text-primary">Property Details of "<%= listing.title %>"</h3>

    <div class="card shadow-sm mb-4">
      <img src="<%= listing.image.url %>" 
           class="card-img-top img-fluid" 
           style="max-height: 400px; object-fit: cover;" 
           alt="<%= listing.title %>">
      <div class="card-body">
        <h5 class="card-title"><%= listing.title %></h5>
        <p class="card-text"><%= listing.description %></p>

        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item"><strong>Owned By:</strong> <%= listing.owner.username %></li>
          <li class="list-group-item"><strong>Price:</strong> â‚¹<%= listing.price.toLocaleString("en-IN") %> /-</li>
          <li class="list-group-item"><strong>Location:</strong> <%= listing.location %>, <%= listing.country %></li>
        </ul>

        <% if(currUser && listing.owner._id.equals(currUser._id)) { %>
          <div class="d-flex gap-2">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning btn-sm">Edit Listing</a>
            <form action="/listings/<%= listing._id %>?_method=DELETE" method="post">
              <button class="btn btn-danger btn-sm">Delete Listing</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Reviews Section -->
    <h4 class="mb-3">All Reviews</h4>

    <% if(currUser) { %>
      <div class="card p-3 mb-4 shadow-sm">
        <form action="/listings/<%= listing._id %>/reviews" method="post">
          <div class="mb-3">
            <label class="form-label">Enter Rating</label>
            <input type="number" name="review[rating]" min="1" max="5" required class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Enter Review</label>
            <textarea name="review[comments]" required class="form-control"></textarea>
          </div>
          <button class="btn btn-primary w-100">Submit</button>
        </form>
      </div>
    <% } %>

    <!-- Show Reviews -->
    <% for(let review of listing.reviews) { %>
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <p><strong>Username:</strong> <%= review.author.username %></p>
          <p><strong>Rating:</strong> 
            <% for(let i=1; i<=5; i++) { %>
              <i class="fa-star <%= i <= review.rating ? 'fa-solid text-warning' : 'fa-regular text-muted' %>"></i>
            <% } %>
          </p>
          <p><strong>Review:</strong> <%= review.comments %></p>

          <% if(currUser && currUser._id.equals(review.author._id)) { %>
            <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="post">
              <button class="btn btn-sm btn-outline-danger mt-2">Delete</button>
            </form>
          <% } %>
        </div>
      </div>
    <% } %>

  </div>
</body>
